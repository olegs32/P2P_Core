GET /api/check_version
|
|-- check_version(x_client_token: str)
    |
    |-- Проверка x_client_token в AUTHORIZED_TOKENS
    |
    |-- Возврат JSON-ответа с версией, URL загрузки и примечаниями к выпуску


GET /downloads/client.exe
|
|-- download_client()
    |
    |-- Возврат FileResponse("dist/client2.exe")


GET /agent/auth
|
|-- agent_auth(hostname: str, passphrase: str)
    |
    |-- Формирование client_id
    |
    |-- Проверка client_id в lp.clients
    |
    |-- Если client_id не найден:
        |
        |-- Проверка passphrase
        |
        |-- Вызов lp.add_client(client_id)
        |
        |-- Возврат JSON-ответа с client_id и success


GET /agent/lp
|
|-- get_long_poll(client_id: str, last_id: int)
    |
    |-- Проверка наличия client_id в REQUEST_TRACKER
    |   |
    |   |-- Если client_id найден:
    |       |
    |       |-- Получение waiting из REQUEST_TRACKER
    |       |
    |       |-- Цикл по waiting для подтверждения доставки сообщений
    |           |
    |           |-- Вызов lp.push(client_id, waiting[ack], {'service': 'ack', 'action': ack})
    |           |
    |           |-- Удаление подтвержденных сообщений из REQUEST_TRACKER
    |
    |-- Вызов lp.get_message(client_id, last_id)
        |
        |-- LongPollServer.get_message(client_id: str, last_id: int)
            |
            |-- Проверка наличия client_id в self.clients
            |
            |-- Извлечение недоставленных сообщений
            |
            |-- Перемещение новых сообщений в список доставленных
            |
            |-- Ожидание новых сообщений через asyncio.wait_for(queue.get(), timeout=self.timeout)
            |
            |-- Возврат новых сообщений



GET /agent/push
|
|-- push_long_poll(agent_id: str, action: str, service: str)
    |
    |-- Вызов lp.push(src='debug', dst=agent_id, msg={'action': action, 'service': service})
    |
    |-- Возврат результата вызова lp.push


GET /agent/update
|
|-- get_update_operation(agent_id: str, operation_id: str, state: str)
    |
    |-- Вызов state_manager.update_operation(agent_id, operation_id, state)
        |
        |-- AgentStateManager.update_operation(client_id: str, operation_id: str, state: str)
            |
            |-- Обновление состояния операции в client_states
            |
            |-- Печать обновленного состояния
            |
            |-- Добавление состояния в очередь
    |
    |-- Возврат JSON-ответа с статусом


GET /store/deploy
|
|-- lib_project_deploy(project)
    |
    |-- Вызов project_store.tar_project(project)
        |
        |-- ProjectManager.tar_project(project_name: str)
            |
            |-- Проверка наличия проекта в projects
            |
            |-- Создание tarball проекта
            |
            |-- Возврат пути к tarball
    |
    |-- Вызов project_store.get_tar_location(project)
        |
        |-- ProjectManager.get_tar_location(project_name: str)
            |
            |-- Проверка наличия проекта в projects
            |
            |-- Проверка существования tarball
            |
            |-- Возврат пути к tarball
    |
    |-- Возврат FileResponse(tarball)



актуально для версии 2.0.10